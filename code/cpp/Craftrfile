# bachelorthesis
import os
import shutil
import subprocess
from craftr.foreignbuild import make

cxx = load('craftr.lang.cxx')
googletest = load('craftr.lib.googletest').googletest

paths = { 
    'metis' : local('deps/metis'),
    'kahip' : local('deps/KaHIP'),
    'metis_build' : 'build',
    'kahip_build' : 'deploy'
}

includes = ['src/include', 'src/main', 
        'build/metis/include', 'deps/KaHIP/deploy/kaHIP_interface.h']

metislib = Framework()
metis = make('Makefile', 'install', cwd=paths['metis'], 
        outputs=[local('build/metis/lib/libmetis.a')])
cxx.extend_framework(metislib, metis)

kahiplib = Framework()
kahip = gentarget(
        [['./compile.sh']],
        cwd=paths['kahip'],
        outputs=[os.path.join(paths['kahip'], paths['kahip_build'])]
        )
cxx.extend_framework(kahiplib, kahip)

mylib = Framework(
        include = [local(x) for x in includes],
        std = 'c++11',
        warn = 'all',
        debug = options.debug,
        optimize = 'debug' if options.debug else 'speed',
        libs = ['m', 'gmpxx', 'gmp']
        )
mylib_lib = cxx.static_library(
        inputs = cxx.compile_cpp(sources = glob('src/main/*.cpp'), 
            frameworks = [mylib, metislib, kahiplib]),
        output = 'mylib'
        )
cxx.extend_framework(mylib, mylib_lib)

test_bin = cxx.executable(
        inputs = cxx.compile_cpp(sources = glob('src/test/*.cpp'),
            frameworks = [googletest, mylib]),
        output = 'test'
        )

test = runtarget(test_bin)

run = runtarget(test_bin, 
        '--gtest_filter=Run.DISABLED_FromStdinVerbose', '--gtest_also_run_disabled_tests')

run_cutting = runtarget(test_bin, 
        '--gtest_filter=Run.DISABLED_FromStdinCutting', '--gtest_also_run_disabled_tests')

gdb = gentarget([['gdb', '--args', test_bin]], pool='console', explicit=True)

docs = gentarget([['doxygen', '.doxygen.config']], explicit=True, cwd=project_dir)


# Symlink resource file for execution 
try:
    os.symlink(local('src/test/resources'), local('build/resources'))
except:
    pass

# Configure metis
print("Configuring METIS")
subprocess.call([
    'make', 'config', 
    'cc=\"' + session.options['craftr.lang.cxx.toolkit'] + '\"',
    'prefix=\"' + local('build/metis') + '\"',
    ], 
    cwd=paths['metis']
    )
print("Finished configuring METIS")

